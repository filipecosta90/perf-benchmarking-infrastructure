---
- hosts: all
  connection: ssh
  become: yes
  become_user: root
  become_method: sudo
  roles:
  - cloudalchemy.prometheus
  vars:
    # prometheus_targets:
      # node:
      # - targets:
      #   - localhost:9100
      #   labels:
      #     env: perf-cto-prometheus
    prometheus_scrape_configs:
      - job_name: 'node'
        ec2_sd_configs:
          - region: "{{ lookup('env','EC2_REGION') }}"
            access_key: "{{ lookup('env','EC2_ACCESS_KEY') }}"
            secret_key: "{{ lookup('env','EC2_SECRET_KEY') }}"
            port: 9100
        relabel_configs:
            # Only monitor instances with a Name starting with "perf"
          - source_labels: [__meta_ec2_tag_Name]
            regex: perf.*
            action: keep
            # Use the instance ID as the instance label
          - source_labels: [__meta_ec2_instance_id]
            target_label: instance